<?xml version="1.0" encoding="UTF-8"?>
<project name="PNW1" default="dist" basedir=".">

  <!--自分のPCの，Tomcatの場所を指定してください-->
  <!--文字列の最後は，スラッシュ[/」無しでお願いします-->
  <property name="TOMCAT_HOME" location="C:\xampp\tomcat"/>

  <description>This buildfile was generated by GenerateAnt plugin for IntelliJ IDEA</description>
  <!--set global properties for this build-->
  <property name="src" location="WEB-INF/src" />
  <property name="build" location="WEB-INF/classes" />
 <property name="lib" location="${TOMCAT_HOME}/lib" />
  <property name="dist" location="dist" />
  <property name="docsapi" location="apidocs"/>

  <!--valueのところに，グループ名(a~nのどれか)を定義してください!!-->
  <!--グループメンバーどうしで確認しあって下さい-->
  <property name="GNO" value="e"/>
  
	<!-- ユーザ名.つまり，@edu.teu.ac.jpの@より前の部分-->
	<property name="scp.user" value="2024e"/>
	<!-- パスワード-->
	<!-- パスワードに＆がある場合は，＆→&amp;　にしてください．-->
	<property name="scp.pass" value="2024e"/>
	<property name="scp.server" value="pnw.cloud.cs.priv.teu.ac.jp"/> 


    <target name="clean">
    <!--Delete created directory trees-->
    <delete dir="${build}" includeEmptyDirs="true" />
    <delete includeEmptyDirs="true">
      <fileset dir="${dist}" excludes="lib/**" />
    </delete>

  </target>
  <target name="init">
    <!--creates the build directory-->
    <mkdir dir="${build}" />
    <mkdir dir="${dist}" />
  </target>

  <target name="build" depends="init">
    <!--Compiles the java code from ${src} directory into ${build} directory-->
   <javac encoding="utf-8" destdir="${build}" source="11" target="11">
    <!--<javac  destdir="${build}">-->
      <src path="${src}" />
     <classpath path="${lib}/servlet-api.jar" />  
     <classpath path="${lib}/jsp-api.jar" /> 
      <!--<exclude name="**/*Test.java" />
      <exclude name="**/Test*.java" />  -->
    </javac>
  </target>


  <target name="doc" depends="init">
    <javadoc destdir="${docsapi}" author="true" version="true" use="true" windowtitle="API for pnw" encoding="UTF-8">
      <fileset dir="${src}" defaultexcludes="yes">
        <!--<exclude name="**/*Test.java" />
        <exclude name="**/Test*.java" />  -->
      </fileset>
    </javadoc>
  </target>

  <target name="war" depends="clean,init,build">
		<war destfile="${dist}/2024${GNO}.war" webxml="WEB-INF/web.xml">
			<fileset dir=".">
				<include name="**/*" /> 
				<!--<include name="**/*.jsp" />-->
				<include name="**/*.html" />
				<include name="**/*.css" />
				<exclude name="WEB-INF/src/" />
				<exclude name="**/*.java"/>
				<exclude name="jsch-0.1.55.jar" />
				<exclude name="WEB-INF/src/" />
				<exclude name="**/*.java"/>
				<exclude name="build.xml" />
				<exclude name="ant/**"/>
				<exclude name="**/*.bat" />
				<exclude name="**/*.sh" />
			</fileset>
			<!-- クラス全部 -->
		<classes dir="WEB-INF/classes" />
		</war>
  </target>

  <target name="localcopy" depends="war">
		<copy file="${dist}/2024g${GNO}.war" todir="${TOMCAT_HOME}/webapps/"/>
  <echo message="tomcat再起動後，http://localhost:8080/2024g${GNO}/...でアクセスしてください．"/>
  </target>
  
  <target name="scp" depends="war">
		<scp file="${dist}/2024${GNO}.war" todir="${scp.user}:${scp.pass}@${scp.server}:/opt/tomcat/apache-tomcat-9.0.45/webapps/2024${GNO}.war" port="22" trust="yes" />
  <echo message="転送後，10秒ほど待ってから，http://${scp.server}:8080/2024${GNO}/...でアクセスしてください．"/>
  </target>
	<tstamp>
		<format property="yyyymmdd" pattern="yyyy-MM-dd" />
	</tstamp>
	
<target name="error">
  <sshexec host="${scp.server}"
    username="${scp.user}"
    password="${scp.pass}"
    trust="yes"
    command="grep -A 50 -a 2024${GNO} /opt/tomcat/apache-tomcat-9.0.45/logs/localhost.${yyyymmdd}.log > /opt/tomcat/apache-tomcat-9.0.45/webapps/2024${GNO}/error.log"/>
</target>

<target name="log" depends="error">
		<scp file="${scp.user}:${scp.pass}@${scp.server}:/opt/tomcat/apache-tomcat-9.0.45/webapps/2024${GNO}/error.log" todir="." trust="yes" />

</target>



</project>

